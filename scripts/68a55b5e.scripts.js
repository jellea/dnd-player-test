"use strict";angular.module("playerApp",["ngStorage"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("playerApp").controller("MainCtrl",["$scope","dndfiles",function(){}]),angular.module("playerApp").controller("PlaylistCtrl",["$scope","$rootScope","$http","player","disco","$localStorage",function(a,b,c,d,e){a.player=d,a.albums=e.theka,b.$on("newtrackadded",function(){console.log("newtrackadded"),a.$apply()})}]),angular.module("playerApp").factory("player",["audio","$rootScope",function a(b,c){var a,d=[],e=!1,f={album:0,track:0};return a={playlist:d,current:f,playing:!1,play:function(c,g){if(d.length){angular.isDefined(c)&&(f.track=c),angular.isDefined(g)&&(f.album=g);var h=new FileReader;a.playing=!0,h.onload=function(a){b.src=a.target.result,b.play(),e=!1},h.readAsDataURL(d[f.album].tracks[f.track].file)}},pause:function(){a.playing&&(b.pause(),a.playing=!1,e=!0)},reset:function(){a.pause(),f.album=0,f.track=0},next:function(){d.length&&(e=!1,d[f.album].tracks.length>f.track+1?f.track++:(f.track=0,f.album=(f.album+1)%d.length),a.playing&&a.play())},previous:function(){d.length&&(e=!1,f.track>0?f.track--:(f.album=(f.album-1+d.length)%d.length,f.track=d[f.album].tracks.length-1),a.playing&&a.play())}},d.add=function(a){-1==d.indexOf(a)&&d.push(a)},d.remove=function(b){var c=d.indexOf(b);c==f.album&&a.reset(),d.splice(c,1)},b.addEventListener("ended",function(){c.$apply(a.next)},!1),a}]),angular.module("playerApp").factory("audio",["$document",function(a){var b=a[0].createElement("audio");return b}]),angular.module("playerApp").service("disco",["$rootScope","$localStorage",function b(a){var b={theka:[],add:function(c,d,e){var f=b.theka.filter(function(a){return a.path==d?a:void 0});f.length>0?b.theka.map(function(a){a.path==d&&("undefined"==typeof a.artist&&"undefined"==typeof a.title&&(a.artist=c.artist,a.title=c.album),a.tracks.push({title:c.title,file:e}))}):b.theka.push({title:c.album,artist:c.artist,path:d,tracks:[{title:c.title,file:e}]}),a.$broadcast("newtrackadded")}};return b}]),angular.module("playerApp").factory("dndfiles",["$document","$rootScope","disco",function(a,b,c){function d(a){var b=document.documentElement;this.dragenter=function(a){a.stopPropagation(),a.preventDefault(),b.classList.add("dropping")},this.dragover=function(a){a.stopPropagation(),a.preventDefault()},this.dragleave=function(a){a.stopPropagation(),a.preventDefault()},this.drop=function(c){return c.stopPropagation(),c.preventDefault(),b.classList.remove("dropping"),a(c.dataTransfer.files,c),!1},b.addEventListener("dragenter",this.dragenter,!1),b.addEventListener("dragover",this.dragover,!1),b.addEventListener("dragleave",this.dragleave,!1),b.addEventListener("drop",this.drop,!1)}var e=new d(function(a,c){var d=c.dataTransfer.items;g(d,function(a){b.$broadcast("file-Drop",a)})}),f=function(a){a.file(function(b){var d=a.fullPath.split("/")[a.fullPath.split("/").length-2];if("audio/mp3"==b.type){var e=new FileReader;e.onload=function(){var a=new jDataView(this.result);if("TAG"==a.getString(3,a.byteLength-128)){var e={title:a.getString(30,a.tell()),artist:a.getString(30,a.tell()),album:a.getString(30,a.tell()),year:a.getString(4,a.tell())};c.add(e,d,b)}},e.readAsArrayBuffer(b)}else if("image"==b.type.split("/")[0]){var f=new FileReader;f.onload=function(a){var b=c.theka.filter(function(a){return a.path==d?a:void 0});0==b.length&&c.theka.push({albumart:a.target.result,path:d,tracks:[]})},f.readAsDataURL(b)}})},g=function(a){for(var a=a,b=function(a){console.log(a)},c=function(a){if(a.isDirectory){var d=a.createReader();d.readEntries(function(a){for(var b=0;b<a.length;++b)c(a[b])},b)}else f(a)},d=0;d<a.length;++d)c(a[d].webkitGetAsEntry())};return{dnd:e,dirRead:g}}]);